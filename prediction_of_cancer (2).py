# -*- coding: utf-8 -*-
"""prediction of cancer.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/180_g4_vDxhPO3AwopUHUKLAtyymt79cr
"""

import streamlit as st
import pandas as pd
import numpy as np
from sklearn.ensemble import RandomForestClassifier
import joblib
import os

# --- 1. PAGE CONFIGURATION (MUST BE FIRST) ---
st.set_page_config(
    page_title="Cancer Risk AI - Hospital Demo",
    page_icon="üè•",
    layout="wide"
)

# --- 2. MODEL PREPARATION ---
# This function ensures the model exists. If you haven't uploaded 'cancer_model.joblib',
# it will train one on the fly using your CSV so the demo never crashes.
@st.cache_resource
def load_or_train_model():
    model_path = 'cancer_model.joblib'
    data_path = 'cancer_prediction.csv'

    if os.path.exists(model_path):
        return joblib.load(model_path)
    elif os.path.exists(data_path):
        df = pd.read_csv(data_path)
        X = df.drop('Diagnosis', axis=1)
        y = df['Diagnosis']
        model = RandomForestClassifier(n_estimators=100, random_state=42)
        model.fit(X, y)
        joblib.dump(model, model_path)
        return model
    else:
        return None

model = load_or_train_model()

# --- 3. CUSTOM STYLING ---
st.markdown("""
    <style>
    .main { background-color: #f0f2f6; }
    .prediction-box {
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
    }
    </style>
    """, unsafe_allow_html=True)

# --- 4. HEADER ---
st.title("üè• Cancer Prediction & Risk Analysis")
st.markdown("Designed for clinical decision support and patient awareness.")

if model is None:
    st.error("Error: 'cancer_prediction.csv' not found. Please upload the dataset to the repository.")
    st.stop()

# --- 5. SIDEBAR INPUTS ---
st.sidebar.header("üìã Patient Clinical Data")

def get_user_inputs():
    age = st.sidebar.slider("Age of Patient", 18, 100, 45)
    gender = st.sidebar.selectbox("Biological Sex", ["Female", "Male"])
    bmi = st.sidebar.number_input("BMI (Body Mass Index)", 15.0, 45.0, 24.0)
    smoking = st.sidebar.radio("Smoking History", ["No", "Yes"])
    genetics = st.sidebar.selectbox("Genetic Risk Factor", ["Low", "Medium", "High"])
    activity = st.sidebar.slider("Physical Activity (Hours/Week)", 0, 10, 3)
    alcohol = st.sidebar.slider("Alcohol Intake (Units/Week)", 0, 5, 1)
    history = st.sidebar.radio("Family History of Cancer", ["No", "Yes"])

    # Map inputs to match the CSV structure
    data = {
        'Age': age,
        'Gender': 1 if gender == "Male" else 0,
        'BMI': bmi,
        'Smoking': 1 if smoking == "Yes" else 0,
        'GeneticRisk': {"Low": 0, "Medium": 1, "High": 2}[genetics],
        'PhysicalActivity': activity,
        'AlcoholIntake': alcohol,
        'CancerHistory': 1 if history == "Yes" else 0
    }
    return pd.DataFrame(data, index=[0])

input_df = get_user_inputs()

# --- 6. MAIN DASHBOARD ---
col1, col2 = st.columns([1, 1])

with col1:
    st.subheader("Patient Summary")
    st.dataframe(input_df.T.rename(columns={0: 'Patient Values'}), use_container_width=True)

with col2:
    st.subheader("Diagnostic Prediction")

    if st.button("Analyze Risk Profile"):
        prediction = model.predict(input_df)[0]
        probability = model.predict_proba(input_df)[0][1] * 100

        if prediction == 1:
            st.markdown(f"""
                <div style="background-color:#ff4b4b; color:white; padding:20px; border-radius:10px;">
                    <h3>HIGH RISK DETECTED</h3>
                    <p>Calculated Probability: {probability:.1f}%</p>
                </div>
                """, unsafe_allow_html=True)
            st.warning("Action Required: Immediate clinical screening and biopsy consultation recommended.")
        else:
            st.markdown(f"""
                <div style="background-color:#28a745; color:white; padding:20px; border-radius:10px;">
                    <h3>LOW RISK DETECTED</h3>
                    <p>Calculated Probability: {probability:.1f}%</p>
                </div>
                """, unsafe_allow_html=True)
            st.success("Action: Continue routine annual check-ups and maintain current lifestyle.")

        # Visual Gauge
        st.write("### Risk Spectrum")
        st.progress(int(probability))

# --- 7. FOOTER ---
st.markdown("---")
st.info("**Hospital Demo Version 1.0** | Built with Random Forest Classifier | Trained on clinical dataset.")